<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <title>BoxJs</title>
    <meta charset="utf-8" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"" />
    <link rel="Bookmark" href="https://raw.githubusercontent.com/chavyleung/scripts/master/BOXJS.png" />
    <link rel="shortcut icon" href="https://raw.githubusercontent.com/chavyleung/scripts/master/BOXJS.png" />
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/chavyleung/scripts/master/BOXJS.png" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.x/css/materialdesignicons.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet" />
    <style>
      [v-cloak] {
        display: none;
      }
      .text-pre-wrap {
        white-space: pre-wrap !important;
      }
      body {
        padding-top: constant(safe-area-inset-top) !important;
        padding-top: env(safe-area-inset-top);
      }
      .v-app-bar,
      .v-navigation-drawer__content {
        box-sizing: content-box;
        padding-top: constant(safe-area-inset-top);
        padding-top: env(safe-area-inset-top);
      }
      .v-app-bar .v-autocomplete {
        box-sizing: border-box;
      }
      .v-bottom-navigation,
      .v-bottom-sheet {
        padding-bottom: constant(safe-area-inset-bottom);
        padding-bottom: env(safe-area-inset-bottom);
      }
      .v-bottom-navigation {
        box-sizing: content-box;
      }
      .v-bottom-navigation button {
        box-sizing: border-box;
      }
      .v-main.safe {
        margin-bottom: 56px;
        padding-bottom: constant(safe-area-inset-bottom);
        padding-bottom: env(safe-area-inset-bottom);
      }
      .v-main .v-main__wrap {
        padding-bottom: constant(safe-area-inset-bottom);
        padding-bottom: env(safe-area-inset-bottom);
      }
      .v-speed-dial {
        margin-bottom: calc(48px + constant(safe-area-inset-bottom));
        margin-bottom: calc(48px + env(safe-area-inset-bottom));
      }
    </style>
  </head>
  <body>
    <div id="app" v-cloak>
      <v-app v-if="box">
        <v-snackbar top app v-model="ui.snackbar.show" v-bind="ui.snackbar">{{ui.snackbar.msg}}</v-snackbar>
        <!-- 头部 -->
        <v-app-bar app dense :color="isDarkMode || !isWebApp ? undefined : 'primary'">
          <!-- 容器切换 Surge、QuanX、Loon -->
          <v-menu bottom left v-if="isMainView">
            <template #activator="{ on }">
              <v-btn icon v-on="on">
                <v-avatar size="26"><img :src="env.icons[iconEnvThemeIdx]" /></v-avatar>
              </v-btn>
            </template>
            <v-list>
              <v-list-item dense v-for="(env, envIdx) in envs" :key="env.id" @click="switchEnv(env.id)">
                <v-list-item-avatar size="26"><v-img :src="env.icon" /></v-list-item-avatar>
                <v-list-item-title>{{env.id}}</v-list-item-title>
              </v-list-item>
            </v-list>
          </v-menu>
          <!-- 返回按钮 -->
          <v-btn icon :dark="isWebApp" @click="back" v-else><v-icon>mdi-chevron-left</v-icon></v-btn>
          <!-- 搜索条 -->
          <v-autocomplete
            v-bind="ui.searchBar"
            :items="apps"
            :label="`BoxJs - v${version}`"
            :filter="(item, queryText, itemText) => { return item.id.includes(queryText) || item.name.includes(queryText) }"
            no-data-text="无数据!"
            hide-details
            solo
            dense
          >
            <template #item="{ item }">
              <v-list-item @click="switchAppView(item.id)" dense>
                <v-list-item-avatar><img :src="item.icon" /></v-list-item-avatar>
                <v-list-item-content>
                  <v-list-item-title>{{`${item.name} (${item.id})`}}</v-list-item-title>
                  <v-list-item-subtitle>{{item.repo}}</v-list-item-subtitle>
                  <v-list-item-subtitle>{{item.author}}</v-list-item-subtitle>
                </v-list-item-content>
                <v-list-item-action>
                  <v-btn icon @click.stop="favApp(item.id)">
                    <v-icon :color="item.favIconColor" v-text="item.favIcon" />
                  </v-btn>
                </v-list-item-action>
              </v-list-item>
            </template>
          </v-autocomplete>
          <!-- 侧栏开关 -->
          <v-btn icon @click="ui.naviDrawer.show = true">
            <v-avatar size="26"><img :src="box.syscfgs.orz3.icon" /></v-avatar>
          </v-btn>
        </v-app-bar>
        <!-- 侧栏 -->
        <v-navigation-drawer app v-model="ui.naviDrawer.show" temporary right>
          <v-list dense nav>
            <v-list-item dense @click="window.open(box.syscfgs.chavy.repo)">
              <v-list-item-avatar><img :src="box.syscfgs.chavy.icon" /></v-list-item-avatar>
              <v-list-item-content>
                <v-list-item-title>{{box.syscfgs.chavy.id}}</v-list-item-title>
                <v-list-item-subtitle>{{box.syscfgs.chavy.repo}}</v-list-item-subtitle>
              </v-list-item-content>
            </v-list-item>
            <v-list-item dense @click="window.open(box.syscfgs.senku.repo)">
              <v-list-item-avatar><img :src="box.syscfgs.senku.icon" /></v-list-item-avatar>
              <v-list-item-content>
                <v-list-item-title>{{box.syscfgs.senku.id}}</v-list-item-title>
                <v-list-item-subtitle>{{box.syscfgs.senku.repo}}</v-list-item-subtitle>
              </v-list-item-content>
            </v-list-item>
            <v-divider></v-divider>
            <v-list-item class="pt-1">
              <v-row justify="start" no-gutters>
                <v-col v-for="(c, cIdx) in ui.contributors" cols="2" :key="c.id">
                  <v-tooltip bottom>
                    <template v-slot:activator="{ on, attrs }">
                      <a>
                        <v-avatar v-on="on" class="ma-1" size="26" @click="window.open(c.repo)">
                          <img :src="c.icon" />
                        </v-avatar>
                      </a>
                    </template>
                    <span>{{c.login}}</span>
                  </v-tooltip>
                </v-col>
              </v-row>
            </v-list-item>
            <v-divider></v-divider>
            <v-list-item v-if="box.syscfgs.env === 'Surge'">
              <v-list-item-content>
                <v-select
                  v-if="box.usercfgs.httpapis"
                  hide-details
                  v-model="box.usercfgs.httpapi"
                  :items="box.usercfgs.httpapis.split(',')"
                  @change="saveUserCfgs"
                  label="HTTP-API (Surge TF)"
                >
                </v-select>
                <v-text-field
                  v-else
                  label="HTTP-API (Surge TF)"
                  v-model="box.usercfgs.httpapi"
                  hint="Surge http-api 地址."
                  placeholder="examplekey@127.0.0.1:6166"
                  persistent-hint
                  @change="saveUserCfgs"
                  :rules="[(val)=> /.*?@.*?:[0-9]+/.test(val) || '格式错误: examplekey@127.0.0.1:6166']"
                >
                </v-text-field>
              </v-list-item-content>
            </v-list-item>
            <v-list-item>
              <v-list-item-content>
                <v-select
                  hide-details
                  v-model="box.usercfgs.theme"
                  :items="[{text: '跟随系统', value: 'auto'}, {text: '暗黑', value: 'dark'}, {text: '明亮', value: 'light'}]"
                  label="颜色主题"
                >
                </v-select>
              </v-list-item-content>
            </v-list-item>
            <v-list-item class="mt-4">
              <v-switch
                dense
                class="mt-0"
                label="透明图标"
                v-model="box.usercfgs.isTransparentIcons"
                @change="saveUserCfgs"
                :hide-details="isDarkMode"
                :persistent-hint="true"
                hint="明亮主题下强制使用彩色图标"
              >
              </v-switch>
              <v-spacer></v-spacer>
              <v-btn fab small text @click="window.open(box.syscfgs.orz3.repo)">
                <v-avatar size="32"><img :src="box.syscfgs.orz3.icon" /></v-avatar>
              </v-btn>
            </v-list-item>
            <v-list-item class="mt-4">
              <v-switch
                dense
                class="mt-0"
                label="勿扰模式"
                hint="不再发出系统通知 (仍记日志)"
                persistent-hint
                v-model="box.usercfgs.isMute"
                @change="saveUserCfgs"
              ></v-switch>
              <v-spacer></v-spacer>
              <v-btn fab small text>
                <v-avatar size="32"><v-icon>mdi-volume-off</v-icon></v-avatar>
              </v-btn>
            </v-list-item>
            <v-list-item class="mt-4">
              <v-switch
                dense
                class="mt-0"
                label="隐藏帮助按钮"
                hint="隐藏悬浮按钮中的帮忙"
                persistent-hint
                v-model="box.usercfgs.isHideHelp"
                @change="saveUserCfgs"
              ></v-switch>
              <v-spacer></v-spacer>
              <v-btn fab small text @click="window.open(box.syscfgs.boxjs.repo)">
                <v-avatar size="32"><v-icon>mdi-help</v-icon></v-avatar>
              </v-btn>
            </v-list-item>
            <v-list-item class="mt-4">
              <v-switch
                dense
                class="mt-0"
                label="隐藏悬浮按钮"
                hint="右下角悬浮按钮"
                persistent-hint
                v-model="box.usercfgs.isHideBoxIcon"
                @change="saveUserCfgs"
              ></v-switch>
              <v-spacer></v-spacer>
              <v-btn fab small text @click="window.open(box.syscfgs.boxjs.repo)">
                <v-avatar size="32">
                  <img :src="box.syscfgs.boxjs.icons[iconThemeIdx]" />
                </v-avatar>
              </v-btn>
            </v-list-item>
            <v-list-item class="mt-4">
              <v-switch
                dense
                class="mt-0"
                label="隐藏我的标题"
                hint="底栏`我的`二字 (只显示图标)"
                persistent-hint
                v-model="box.usercfgs.isHideMyTitle"
                @change="saveUserCfgs"
              ></v-switch>
              <v-spacer></v-spacer>
              <v-btn fab small text>
                <v-avatar v-if="box.usercfgs.icon" size="32">
                  <img :src="box.usercfgs.icon" />
                </v-avatar>
                <v-icon v-else size="32">mdi-face-profile</v-icon>
              </v-btn>
            </v-list-item>
            <v-list-item class="mt-4">
              <v-switch
                dense
                class="mt-0"
                label="隐藏刷新按钮"
                hint="双击悬浮按钮也可刷新页面"
                persistent-hint
                v-model="box.usercfgs.isHideRefresh"
                @change="saveUserCfgs"
              ></v-switch>
              <v-spacer></v-spacer>
              <v-btn fab small text>
                <v-avatar size="32"><v-icon>mdi-refresh</v-icon></v-avatar>
              </v-btn>
            </v-list-item>
            <v-list-item class="mt-4">
              <v-switch
                dense
                class="mt-0"
                label="调试模式 (页面)"
                hint="每次访问都获取最新的页面"
                persistent-hint
                v-model="box.usercfgs.isDebugWeb"
                @change="saveUserCfgs"
              ></v-switch>
              <v-spacer></v-spacer>
              <v-btn fab small text>
                <v-avatar size="32"><v-icon>mdi-language-html5</v-icon></v-avatar>
              </v-btn>
            </v-list-item>
            <!-- <v-list-item class="mt-4">
              <v-switch
                dense
                class="mt-0"
                hide-details
                label="隐藏底部导航"
                v-model="box.usercfgs.isHideNavi"
                @change="saveUserCfgs"
              ></v-switch>
            </v-list-item>
            <v-list-item class="mt-4">
              <v-switch
                dense
                class="mt-0"
                hide-details
                label="隐藏更新订阅提示"
                v-model="box.usercfgs.isHideRefreshTip"
                @change="saveUserCfgs"
              ></v-switch>
            </v-list-item>
            <v-list-item class="mt-4">
              <v-switch
                dense
                class="mt-0"
                hide-details
                label="调试模式 (数据)"
                v-model="box.usercfgs.isDebugData"
                @change="saveUserCfgs"
              ></v-switch>
            </v-list-item>
            <v-list-item class="mt-4">
              <v-switch
                dense
                class="mt-0"
                hide-details
                label="调试模式 (格式)"
                v-model="box.usercfgs.isDebugFormat"
                @change="saveUserCfgs"
              ></v-switch>
            </v-list-item> -->
          </v-list>
        </v-navigation-drawer>
        <!-- 主页 -->
        <v-main class="safe">
          <!-- 主页 -->
          <v-container fluid v-if="view === ''" v-scroll="onScroll">
            <!-- TODO -->
          </v-container>
          <!-- 应用列表 -->
          <v-container fluid v-else-if="view === 'app' && !curapp" v-scroll="onScroll">
            <!-- 收藏应用 -->
            <v-expansion-panels multiple class="mb-4" v-if="favApps.length > 0" v-model="box.usercfgs.favapppanel">
              <v-expansion-panel>
                <v-expansion-panel-header>
                  收藏应用 ({{favApps.length}})
                </v-expansion-panel-header>
                <v-expansion-panel-content>
                  <v-list class="ma-n4">
                    <template v-for="(app, appIdx) in favApps" :key="app.id">
                      <v-list-item dense three-line @click="switchAppView(app.id)">
                        <v-list-item-avatar><v-img :src="app.icon" /></v-list-item-avatar>
                        <v-list-item-content>
                          <v-list-item-title>{{app.name}} ({{app.id}})</v-list-item-title>
                          <v-list-item-subtitle>{{app.repo}}</v-list-item-subtitle>
                          <v-list-item-subtitle>{{app.author}}</v-list-item-subtitle>
                        </v-list-item-content>
                        <v-list-item-action>
                          <v-menu bottom left>
                            <template #activator="{ on }">
                              <v-btn icon v-on="on"><v-icon>mdi-dots-vertical</v-icon></v-btn>
                            </template>
                            <v-list>
                              <v-list-item dense v-if="appIdx > 0" @click="moveFav(appIdx, -1)">
                                <v-list-item-title>上移</v-list-item-title>
                              </v-list-item>
                              <v-list-item dense v-if="appIdx + 1 < favApps.length" @click="moveFav(appIdx, 1)">
                                <v-list-item-title>下移</v-list-item-title>
                              </v-list-item>
                              <v-divider v-if="favApps.length > 1"></v-divider>
                              <v-list-item dense @click="favApp(app.id)">
                                <v-list-item-title>取消收藏</v-list-item-title>
                              </v-list-item>
                            </v-list>
                          </v-menu>
                        </v-list-item-action>
                      </v-list-item>
                      <!-- <v-divider inset v-if="favApps.length !== appIdx + 1"></v-divider> -->
                    </template>
                  </v-list>
                </v-expansion-panel-content>
              </v-expansion-panel>
            </v-expansion-panels>
            <!-- 订阅应用 -->
            <v-expansion-panels multiple class="mb-4" v-if="appSubs.length > 0" v-model="box.usercfgs.subapppanel">
              <v-expansion-panel v-for="(sub, subIdx) in appSubs" :key="sub.id" v-if="!sub.isErr">
                <v-expansion-panel-header>
                  {{sub.name}} ({{sub.apps.length}})
                </v-expansion-panel-header>
                <v-expansion-panel-content>
                  <v-list class="ma-n4">
                    <template v-for="(app, appIdx) in sub.apps" :key="app.id">
                      <v-list-item dense three-line @click="switchAppView(app.id)">
                        <v-list-item-avatar><v-img :src="app.icon" /></v-list-item-avatar>
                        <v-list-item-content>
                          <v-list-item-title>{{app.name}} ({{app.id}})</v-list-item-title>
                          <v-list-item-subtitle>{{app.repo}}</v-list-item-subtitle>
                          <v-list-item-subtitle>{{app.author}}</v-list-item-subtitle>
                        </v-list-item-content>
                        <v-list-item-action>
                          <v-btn icon @click.stop="favApp(app.id)">
                            <v-icon :color="app.favIconColor" v-text="app.favIcon" />
                          </v-btn>
                        </v-list-item-action>
                      </v-list-item>
                      <!-- <v-divider inset v-if="sub.apps.length !== appIdx + 1"></v-divider> -->
                    </template>
                  </v-list>
                </v-expansion-panel-content>
              </v-expansion-panel>
            </v-expansion-panels>
            <!-- 内置应用 -->
            <v-expansion-panels multiplev-if="sysApps.length > 0" v-model="box.usercfgs.sysapppanel">
              <v-expansion-panel>
                <v-expansion-panel-header>
                  内置应用 ({{sysApps.length}})
                </v-expansion-panel-header>
                <v-expansion-panel-content>
                  <v-list class="ma-n4">
                    <template v-for="(app, appIdx) in sysApps" :key="app.id">
                      <v-list-item dense three-line @click="switchAppView(app.id)">
                        <v-list-item-avatar><v-img :src="app.icon" /></v-list-item-avatar>
                        <v-list-item-content>
                          <v-list-item-title>{{app.name}} ({{app.id}})</v-list-item-title>
                          <v-list-item-subtitle>{{app.repo}}</v-list-item-subtitle>
                          <v-list-item-subtitle>{{app.author}}</v-list-item-subtitle>
                        </v-list-item-content>
                        <v-list-item-action>
                          <v-btn icon @click.stop="favApp(app.id)">
                            <v-icon :color="app.favIconColor" v-text="app.favIcon" />
                          </v-btn>
                        </v-list-item-action>
                      </v-list-item>
                      <!-- <v-divider inset v-if="sysApps.length !== appIdx + 1"></v-divider> -->
                    </template>
                  </v-list>
                </v-expansion-panel-content>
              </v-expansion-panel>
            </v-expansion-panels>
          </v-container>
          <!-- 应用详情 -->
          <v-container fluid v-else-if="view === 'app' && !!curapp" v-scroll="onScroll">
            <v-subheader>
              <h2>{{curapp.name}}</h2>
              <v-spacer></v-spacer>
              <v-btn v-if="curapp.script" icon @click="runScript(curapp.script, curapp.script_timeout)">
                <v-icon color="primary">mdi-play-circle</v-icon>
              </v-btn>
            </v-subheader>
            <v-card flat class="mb-4" color="transparent" v-if="curapp.desc || curapp.descs || curapp.desc_html || curapp.descs_html">
              <v-card-subtitle>
                <p v-if="curapp.desc" v-text="curapp.desc" class="text-pre-wrap"></p>
                <p
                  v-for="(desc, descIdx) in curapp.descs"
                  v-text="desc"
                  :class="curapp.descs.length === descIdx + 1 ? 'curapptext-pre-wrap' : 'mb-0 text-pre-wrap'"
                ></p>
                <p v-if="curapp.desc_html" v-html="curapp.desc_html"></p>
                <div v-for="(desc_html, desc_htmlIdx) in curapp.descs_html" v-html="desc_html"></div>
              </v-card-subtitle>
            </v-card>
            <v-card class="mb-4">
              <template v-if="curapp.scripts">
                <v-subheader>
                  应用脚本 ({{curapp.scripts.length}})
                </v-subheader>
                <v-list dense>
                  <v-list-item v-for="(script, scriptIdx) in curapp.scripts" :key="scriptIdx">
                    <v-list-item-title>
                      {{scriptIdx + 1}}. {{script.name}}
                    </v-list-item-title>
                    <v-btn icon @click.stop="runScript(script.script, script.script_timeout)">
                      <v-icon>mdi-play-circle</v-icon>
                    </v-btn>
                  </v-list-item>
                </v-list>
              </template>
            </v-card>
            <v-card class="mb-4">
              <template v-if="curapp.settings">
                <v-subheader>
                  应用设置 ({{curapp.settings.length}})
                </v-subheader>
                <v-form class="pl-4 pr-4">
                  <template v-for="(setting, settingIdx) in curapp.settings">
                    <v-slider
                      v-model="setting.val"
                      v-bind="setting"
                      class="mt-4"
                      dense
                      persistent-hint
                      :label="setting.name"
                      :hint="setting.desc"
                      thumb-label="always"
                      v-if="setting.type === 'slider'"
                    ></v-slider>
                    <v-switch
                      v-model="setting.val"
                      class="mt-2"
                      persistent-hint
                      dense
                      :label="setting.name"
                      :hint="setting.desc"
                      v-else-if="setting.type === 'boolean'"
                    ></v-switch>
                    <v-textarea
                      v-model="setting.val"
                      v-bind="setting"
                      class="mt-4"
                      :row="3"
                      :label="setting.name"
                      :hint="setting.desc"
                      v-else-if="setting.type === 'textarea'"
                    ></v-textarea>
                    <v-radio-group
                      v-model="setting.val"
                      v-bind="setting"
                      persistent-hint
                      class="mt-0"
                      :hint="setting.desc"
                      v-else-if="setting.type === 'radios'"
                    >
                      <v-subheader class="mb-n4 pa-0">{{setting.name}}</v-subheader>
                      <v-radio
                        :class="itemIdx === 0 ? 'mt-2' : ''"
                        v-for="(item, itemIdx) in setting.items"
                        :label="item.label"
                        :value="item.key"
                        :key="item.key"
                      ></v-radio>
                    </v-radio-group>
                    <template v-else-if="setting.type === 'checkboxes'">
                      <v-subheader class="mb-n8 pa-0">{{setting.name}}</v-subheader>
                      <v-item-group class="mt-4 pt-1">
                        <v-checkbox
                          v-model="setting.val"
                          class="mt-0"
                          persistent-hint
                          :hide-details="itemIdx + 1 !== setting.items.length"
                          :hint="setting.desc"
                          :label="item.label"
                          :value="item.key"
                          v-for="(item, itemIdx) in setting.items"
                          :key="item.key"
                          multiple
                        ></v-checkbox>
                      </v-item-group>
                    </template>
                    <template v-else-if="setting.type === 'colorpicker'">
                      <v-subheader class="mb-n2 pa-0">{{setting.name}}</v-subheader>
                      <v-color-picker
                        v-model="setting.val"
                        v-bind="setting"
                        class="mt-2 mb-4"
                        persistent-hint
                        :hint="setting.desc"
                        :hide-canvas="!setting.canvas"
                        :dot-size="30"
                        mode="hexa"
                        light
                      ></v-color-picker>
                    </template>
                    <div class="mt-4" v-else-if="setting.type === 'number'">
                      <v-text-field
                        v-model="setting.val"
                        v-bind="setting"
                        type="number"
                        :label="setting.name"
                        :hint="setting.desc"
                      ></v-text-field>
                    </div>
                    <div class="mt-4" v-else>
                      <v-text-field v-model="setting.val" v-bind="setting" :label="setting.name" :hint="setting.desc"></v-text-field>
                    </div>
                  </template>
                </v-form>
                <v-divider></v-divider>
                <v-card-actions>
                  <v-spacer></v-spacer>
                  <v-btn small text color="primary" @click="saveAppSettings">保存设置</v-btn>
                </v-card-actions>
              </template>
            </v-card>
            <v-card class="mx-auto" v-if="curapp.datas && curapp.datas.length > 0">
              <v-subheader>
                当前会话
                <a class="ml-2">{{curapp.curSession ? curapp.curSession.name : ''}}</a>
                <v-spacer></v-spacer>
                <v-menu bottom left>
                  <template #activator="{ on }">
                    <v-btn icon v-on="on"><v-icon>mdi-dots-vertical</v-icon></v-btn>
                  </template>
                  <v-list dense>
                    <v-list-item @click="copy(JSON.stringify(curapp))">
                      <v-list-item-title>复制会话</v-list-item-title>
                    </v-list-item>
                    <v-dialog v-model="ui.impAppDatasDialog.show">
                      <template #activator="{ on }">
                        <v-list-item v-on="on">
                          <v-list-item-title>导入会话</v-list-item-title>
                        </v-list-item>
                      </template>
                      <v-card>
                        <v-card-title>
                          导入会话
                        </v-card-title>
                        <v-divider></v-divider>
                        <v-card-text>
                          <v-textarea
                            v-model="ui.impAppDatasDialog.impval"
                            rows="3"
                            clearable
                            autofocus
                            label="会话数据 (JSON)"
                            hint="请粘贴 JSON 格式的会话数据! 你可以通过 复制会话 获得数据."
                          ></v-textarea>
                        </v-card-text>
                        <v-divider></v-divider>
                        <v-card-actions>
                          <v-spacer></v-spacer>
                          <v-btn text small color="grey" text @click="ui.impAppDatasDialog.show = false">取消</v-btn>
                          <v-btn text small color="primary" text @click="impAppDatas()">导入</v-btn>
                        </v-card-actions>
                      </v-card>
                    </v-dialog>
                  </v-list>
                </v-menu>
              </v-subheader>
              <v-list-item two-line dense v-for="(data, dataIdx) in curapp.datas" :key="dataIdx">
                <v-list-item-content>
                  <v-list-item-title>{{data.key}}</v-list-item-title>
                  <v-list-item-subtitle>{{data.val ? data.val : '无数据!'}}</v-list-item-subtitle>
                </v-list-item-content>
                <v-list-item-action>
                  <v-btn icon @click.stop="clearAppDatas(data.key)">
                    <v-icon color="grey">mdi-close</v-icon>
                  </v-btn>
                </v-list-item-action>
              </v-list-item>
              <v-divider></v-divider>
              <v-card-actions>
                <v-spacer></v-spacer>
                <v-btn small text color="primary" @click="saveAppSession">保存会话</v-btn>
              </v-card-actions>
            </v-card>
            <v-card :id="session.id" class="ml-10 mt-4" v-for="(session, sessionIdx) in curapp.sessions" :key="session.id">
              <v-subheader>
                <a v-if="curapp.curSession && curapp.curSession.id === session.id">#{{sessionIdx + 1}} {{session.name}}</a>
                <template v-else>#{{sessionIdx + 1}} {{session.name}}</template>
                <v-spacer></v-spacer>
                <v-menu bottom left>
                  <template v-slot:activator="{ on }">
                    <v-btn icon v-on="on"><v-icon>mdi-dots-vertical</v-icon></v-btn>
                  </template>
                  <v-list dense>
                    <v-list-item @click="">
                      <v-list-item-title>修改会话</v-list-item-title>
                    </v-list-item>
                    <v-divider></v-divider>
                    <v-list-item @click="delAppSession(session.id)">
                      <v-list-item-title>删除会话</v-list-item-title>
                    </v-list-item>
                  </v-list>
                </v-menu>
              </v-subheader>
              <v-list-item two-line dense v-for="(data, dataIdx) in session.datas" :key="dataIdx">
                <v-list-item-content>
                  <v-list-item-title>{{data.key}}</v-list-item-title>
                  <v-list-item-subtitle>{{data.val ? data.val : '无数据!'}}</v-list-item-subtitle>
                </v-list-item-content>
              </v-list-item>
              <v-divider></v-divider>
              <v-card-actions>
                <v-btn small text color="grey">{{dayjs(session.createTime).format('YYYY-MM-DD HH:mm:ss')}}</v-btn>
                <v-spacer></v-spacer>
                <v-btn small text color="primary" @click="useAppSession(session.id)">应用</v-btn>
              </v-card-actions>
            </v-card>
          </v-container>
          <!-- 订阅列表 -->
          <v-container fluid v-else-if="view === 'sub'" v-scroll="onScroll">
            <v-btn v-if="appSubs.length === 0" block class="primary" @click="addAppSubDialog = true">
              添加订阅
            </v-btn>
            <v-card v-else>
              <v-list>
                <v-subheader inset dense>
                  应用订阅 ({{appSubs.length}})
                  <v-spacer></v-spacer>
                  <v-btn icon @click="reloadAppSub()">
                    <v-icon>mdi-refresh-circle</v-icon>
                  </v-btn>
                  <v-btn icon>
                    <v-icon color="primary" @click="addAppSubDialog = true">mdi-plus-circle</v-icon>
                  </v-btn>
                </v-subheader>
                <template v-for="(sub, subIdx) in appSubs" :key="sub.id">
                  <v-list-item dense two-line @click="reloadAppSub(sub)">
                    <v-list-item-avatar v-if="sub.icon"><v-img :src="sub.icon" /></v-list-item-avatar>
                    <v-list-item-avatar v-else color="primary"><v-icon dark>mdi-account</v-icon></v-list-item-avatar>
                    <v-list-item-content>
                      <v-list-item-title>
                        {{sub.name}} ({{sub.apps.length}})
                        <v-chip v-if="sub.isErr" color="pink" dark x-small class="ml-1 mb-1">格式错误</v-chip>
                      </v-list-item-title>
                      <v-list-item-subtitle>{{sub.repo ? sub.repo : sub.url}}</v-list-item-subtitle>
                      <v-list-item-subtitle>{{sub.author ? sub.author : '@anonymous'}}</v-list-item-subtitle>
                      <v-list-item-subtitle>
                        更新于: {{timeago.format(sub.updateTime, 'zh_CN')}}
                      </v-list-item-subtitle>
                    </v-list-item-content>
                    <v-list-item-action>
                      <v-menu bottom left>
                        <template #activator="{ on }">
                          <v-btn icon v-on="on"><v-icon>mdi-dots-vertical</v-icon></v-btn>
                        </template>
                        <v-list dense>
                          <v-list-item @click="reloadAppSub(sub)">
                            <v-list-item-title>更新</v-list-item-title>
                          </v-list-item>
                          <v-list-item @click="copy(sub.url)">
                            <v-list-item-title>复制</v-list-item-title>
                          </v-list-item>
                          <v-divider></v-divider>
                          <v-list-item v-if="subIdx > 0" @click="moveSub(subIdx, -1)">
                            <v-list-item-title>上移</v-list-item-title>
                          </v-list-item>
                          <v-list-item v-if="subIdx + 1 < appSubs.length" @click="moveSub(subIdx, 1)">
                            <v-list-item-title>下移</v-list-item-title>
                          </v-list-item>
                          <v-divider></v-divider>
                          <v-list-item @click="delSub(subIdx)">
                            <v-list-item-title>删除</v-list-item-title>
                          </v-list-item>
                        </v-list>
                      </v-menu>
                    </v-list-item-action>
                  </v-list-item>
                  <v-divider inset v-if="appSubs.length !== subIdx + 1"></v-divider>
                </template>
              </v-list>
            </v-card>
            <v-dialog v-model="addAppSubDialog" scrollable>
              <v-card>
                <v-card-title>添加订阅</v-card-title>
                <v-divider></v-divider>
                <v-card-text>
                  <v-textarea
                    rows="3"
                    clearable
                    autofocus
                    persistent-hint
                    v-model="ui.addAppSubDialog.url"
                    label="订阅地址 (URL)"
                    hint="请粘贴 URL 格式的订阅地址!"
                  ></v-textarea>
                </v-card-text>
                <v-divider></v-divider>
                <v-card-actions>
                  <v-spacer></v-spacer>
                  <v-btn text small color="grey" @click="addAppSubDialog = false">取消</v-btn>
                  <v-btn text small color="primary" @click="addAppSub(ui.addAppSubDialog.url)">添加</v-btn>
                </v-card-actions>
              </v-card>
            </v-dialog>
          </v-container>
          <!-- 我的 -->
          <v-container fluid v-else-if="view === 'my'" v-scroll="onScroll">
            <v-card class="mx-auto">
              <v-card-title class="headline">
                {{box.usercfgs.name ? box.usercfgs.name : '大侠, 留个名字吧!'}}
                <v-spacer></v-spacer>
                <v-dialog v-model="ui.editProfileDialog.show">
                  <template #activator="{ on }">
                    <v-btn icon v-on="on"><v-icon>mdi-cog-outline</v-icon></v-btn>
                  </template>
                  <v-card>
                    <v-card-title>个人资料</v-card-title>
                    <v-divider></v-divider>
                    <v-card-text>
                      <v-text-field label="昵称" v-model="box.usercfgs.name" hint="少侠请留名!"></v-text-field>
                      <v-text-field label="头像 (选填)" v-model="box.usercfgs.icon" hint="头像链接, 建议直接从 GitHub 获取!"></v-text-field>
                    </v-card-text>
                    <v-divider></v-divider>
                    <v-card-actions>
                      <v-spacer></v-spacer>
                      <v-btn text small color="grey" @click="ui.editProfileDialog.show = false">取消</v-btn>
                      <v-btn text small color="primary" @click="ui.editProfileDialog.show = false">保存</v-btn>
                    </v-card-actions>
                  </v-card>
                </v-dialog>
              </v-card-title>
              <v-divider class="mx-4"></v-divider>
              <v-card-text>
                <span class="subheading">我的数据</span>
                <v-chip-group>
                  <v-chip small>应用: {{this.apps.length}}</v-chip>
                  <v-chip small>订阅: {{this.appSubs.length}}</v-chip>
                  <v-chip small>会话: {{this.sessions.length}}</v-chip>
                </v-chip-group>
              </v-card-text>
              <v-card-actions>
                <v-btn text small color="red" @click="">抹掉数据</v-btn>
                <v-spacer></v-spacer>
                <v-dialog v-model="ui.impGlobalBakDialog.show">
                  <template #activator="{ on }">
                    <v-btn small v-on="on">导入</v-btn>
                  </template>
                  <v-card>
                    <v-card-title>
                      导入备份
                    </v-card-title>
                    <v-divider></v-divider>
                    <v-card-text>
                      <v-textarea
                        rows="3"
                        clearable
                        autofocus
                        v-model="ui.impGlobalBakDialog.impval"
                        label="备份内容"
                        hint="请粘贴全局备份内容!"
                      ></v-textarea>
                    </v-card-text>
                    <v-divider></v-divider>
                    <v-card-actions>
                      <v-spacer></v-spacer>
                      <v-btn text small color="grey" text @click="ui.impGlobalBakDialog.show = false">取消</v-btn>
                      <v-btn text small color="primary" text @click="impGlobalBak">导入</v-btn>
                    </v-card-actions>
                  </v-card>
                </v-dialog>
                <v-btn small @click="saveGlobalBak">备份</v-btn>
              </v-card-actions>
            </v-card>
            <v-card class="mt-4" v-if="box.globalbaks">
              <template v-for="(bak, bakIdx) in box.globalbaks">
                <v-divider v-if="bakIdx>0"></v-divider>
                <v-list-item three-line dense @click="switchBakView(bak.id)">
                  <v-list-item-content>
                    <v-list-item-title>{{bak.name}}</v-list-item-title>
                    <v-list-item-subtitle>{{dayjs(bak.createTime).format('YYYY-MM-DD HH:mm:ss')}}</v-list-item-subtitle>
                    <v-list-item-subtitle>
                      <v-chip x-small class="mr-2" v-for="(tag, tagIdx) in bak.tags" :key="tagIdx">{{tag}}</v-chip>
                    </v-list-item-subtitle>
                  </v-list-item-content>
                  <v-list-item-action>
                    <v-btn icon><v-icon>mdi-chevron-right</v-icon></v-btn>
                  </v-list-item-action>
                </v-list-item>
              </template>
            </v-card>
          </v-container>
          <v-container fluid v-else-if="view === 'bak' && !!curbak" v-scroll="onScroll">
            <v-subheader>
              <h2>{{curbak.name}}</h2>
              <v-spacer></v-spacer>
              <v-btn icon color="primary" @click="revertGlobalBak">
                <v-icon>mdi-share-circle</v-icon>
              </v-btn>
            </v-subheader>
            <v-card flat class="mb-4" color="transparent">
              <v-card-subtitle class="py-0">
                <p class="my-0">说明:</p>
                <p class="my-0">1. 点击右上角 <v-icon color="primary" small>mdi-share-circle</v-icon> 按钮还原!</p>
                <p class="my-0">2. 点击 <v-icon color="primary" small>mdi-clipboard-text-multiple</v-icon> 按钮可复制备份.</p>
                <p class="my-0">3. 修改名称为实时保存</p>
              </v-card-subtitle>
            </v-card>
            <v-card class="mb-4">
              <v-subheader>
                备份信息
                <v-spacer></v-spacer>
                <v-btn color="primary" icon @click="copy(JSON.stringify(curbak.bak))">
                  <v-icon size="20">mdi-clipboard-text-multiple</v-icon>
                </v-btn>
              </v-subheader>
              <v-card-text>
                <v-text-field label="备份名称" v-model="curbak.name" @change="updateGlobalBak"> </v-text-field>
              </v-card-text>
              <v-divider></v-divider>
              <v-card-actions>
                <v-spacer></v-spacer>
                <v-btn small text color="error" @click="delGlobalBak">删除备份</v-btn>
              </v-card-actions>
            </v-card>
          </v-container>
        </v-main>
        <!-- 底部 -->
        <v-bottom-navigation app color="primary" :value="view">
          <v-btn @click="switchView('/')" value="">首页<v-icon>mdi-home</v-icon></v-btn>
          <v-btn @click="switchView('/app')" value="app">应用<v-icon>mdi-application</v-icon></v-btn>
          <v-btn @click="switchView('/sub')" value="sub">订阅<v-icon>mdi-database</v-icon></v-btn>
          <v-btn @click="switchView('/my')" value="my">
            <template v-if="myIcon">
              <span v-if="!isHideMyTitle">我的</span>
              <v-avatar :size="isHideMyTitle ? 36 : 24"><v-img :src="myIcon" /></v-avatar>
            </template>
            <template v-else>
              <span v-if="!isHideMyTitle">我的</span>
              <v-icon :size="isHideMyTitle ? 36 : 24">mdi-face-profile</v-icon>
            </template>
          </v-btn>
        </v-bottom-navigation>
        <v-fab-transition>
          <v-speed-dial
            v-show="!box.usercfgs.isHideBoxIcon"
            direction="top"
            fixed
            fab
            bottom
            :left="box.usercfgs.isLeftBoxIcon"
            :right="!box.usercfgs.isLeftBoxIcon === true"
          >
            <template #activator>
              <v-btn fab text @dblclick="window.location.reload()">
                <v-avatar><img :src="box.syscfgs.boxjs.icons[iconThemeIdx]" /></v-avatar>
              </v-btn>
            </template>
            <v-btn dark v-if="!box.usercfgs.isHideHelp" fab small color="grey" @click="ui.versionsheet.show = true">
              <v-icon>mdi-help</v-icon>
            </v-btn>
            <v-btn dark fab small color="pink" @click="box.usercfgs.isLeftBoxIcon = !box.usercfgs.isLeftBoxIcon">
              <v-icon>
                {{box.usercfgs.isLeftBoxIcon ? 'mdi-format-horizontal-align-right' : 'mdi-format-horizontal-align-left'}}
              </v-icon>
            </v-btn>
            <!-- <v-btn dark fab small color="indigo" @click="">
              <v-icon>mdi-database-import</v-icon>
            </v-btn>
            <v-btn dark fab small color="success" @click="">
              <v-icon>mdi-export-variant</v-icon>
            </v-btn> -->
            <v-btn dark v-if="!box.usercfgs.isHideRefresh" fab small color="orange" @dblclick="window.location.reload()">
              <v-icon>mdi-refresh</v-icon>
            </v-btn>
          </v-speed-dial>
        </v-fab-transition>
        <v-bottom-sheet v-model="ui.versionsheet.show" scrollable>
          <v-card v-if="box.versions">
            <v-subheader>
              <v-btn icon small @click="ui.versionsheet.show = false">
                <v-icon>mdi-help-circle</v-icon>
              </v-btn>
              <v-spacer></v-spacer>
              <v-btn text small v-if="hasNewVersion">新版本</v-btn>
              <v-spacer></v-spacer>
              <v-btn icon small @click="ui.versionsheet.show = false">
                <v-icon>mdi-close</v-icon>
              </v-btn>
            </v-subheader>
            <v-divider></v-divider>
            <v-card-text style="height: 80%;">
              <div class="mt-6" v-for="(ver, verIdx) in box.versions">
                <h2 :class="version === ver.version ? 'primary--text' : undefined">v{{ver.version}}</h2>
                <div class="pl-4 pt-2" v-for="(note, noteIdx) in ver.notes">
                  <strong>{{note.name}}</strong>
                  <ul>
                    <li v-for="(desc, descIdx) in note.descs">{{desc}}</li>
                  </ul>
                </div>
              </div>
            </v-card-text>
          </v-card>
        </v-bottom-sheet>
        <v-overlay v-model="ui.overlay.show" :opacity="0.8">
          <v-progress-circular indeterminate :value="ui.overlay.val" :size="64" color="primary"></v-progress-circular>
        </v-overlay>
      </v-app>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.x/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@0.x/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.x/dist/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@4.x/dist/timeago.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@8.x/dist/umd/uuidv4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-clipboard2@0.x/dist/vue-clipboard.min.js"></script>
    <script>
      new Vue({
        el: '#app',
        vuetify: new Vuetify(),
        data() {
          return {
            ui: {
              isCors: false,
              path: null,
              bfpath: null,
              view: null,
              bfview: null,
              subview: null,
              bfsubview: null,
              scrollY: {},
              contributors: [],
              isSaveUserCfgs: false,
              overlay: { show: false, val: 60 },
              snackbar: { show: false, color: 'primary', msg: '' },
              searchBar: { menuProps: { closeOnContentClick: true } },
              versionsheet: { show: false },
              updatesheet: { show: false },
              naviDrawer: { show: false },
              baksSkeleton: { show: true },
              editProfileDialog: { show: false },
              impGlobalBakDialog: { show: false, impval: '' },
              impAppDatasDialog: { show: false, impval: '' },
              addAppSubDialog: { show: false, url: '' },
              defaultIcons: [
                'https://raw.githubusercontent.com/Orz-3/mini/master/appstore.png',
                'https://raw.githubusercontent.com/Orz-3/task/master/appstore.png'
              ]
            },
            box: null
          }
        },
        computed: {
          // 获取当前版本
          version() {
            return this.box.syscfgs.version
          },
          // 判断是否有新版本
          hasNewVersion() {
            const curver = this.box.syscfgs.version
            const vers = this.box.versions
            if (curver && vers && vers.length > 0) {
              const lastestVer = vers[0].version
              return this.compareVersion(lastestVer, curver) > 0
            }
          },
          // 判断是否需要跨域请求
          isCors() {
            return this.ui.isCors
          },
          // 判断当前是否`WebApp`
          isWebApp() {
            return window.navigator.standalone
          },
          // 当前环境: Surge、QuanX、Loon、NodeJs
          env: {
            // 获取当前容器环境
            get() {
              return this.envs.find((env) => env.id === this.box.syscfgs.env)
            },
            // 设置当前容器环境
            set(val) {
              this.box.syscfgs.env = val
            }
          },
          // 获取容器列表
          envs() {
            const envs = this.box.syscfgs.envs
            envs.forEach((env) => (env.icon = env.icons[this.iconThemeIdx]))
            return envs
          },
          // 获取当前路径
          path: {
            get() {
              return this.ui.path
            },
            set(path) {
              this.ui.path = path
            }
          },
          // 获取上一个路径
          bfpath() {
            return this.ui.bfpath || ''
          },
          // 获取当前页面: http://boxjs.com/app/baidu => `app`
          view() {
            return this.ui.view || ''
          },
          // 获取当前页面: http://boxjs.com/app/baidu => `baidu`
          subview() {
            return this.ui.subview ? this.ui.subview : ''
          },
          // 判断当前是否`主页面` (非二级页面)
          isMainView() {
            return this.path.split('/').length < 3
          },
          // 判断当前是否`暗黑模式`
          isDarkMode() {
            let isDark = true
            const theme = this.box.usercfgs.theme
            if (theme === 'auto') {
              isDark = this.isSystemDarkMode
            } else if (theme === 'light') {
              isDark = false
            }
            return isDark
          },
          // 判断系统是否`暗黑模式`
          isSystemDarkMode() {
            return window.matchMedia('(prefers-color-scheme: dark)').matches
          },
          // 是否透明图标
          isTransparentIcons() {
            return this.box.usercfgs.isTransparentIcons
          },
          // 获取图标下标, 透明: 0, 彩色: 1 (默认)
          iconThemeIdx() {
            if (this.isDarkMode) {
              return this.isTransparentIcons ? 0 : 1
            }
            return 1
          },
          // 获取环境图标下标, 透明: 0, 彩色: 1 (默认)
          iconEnvThemeIdx() {
            if (this.isWebApp) {
              return this.isTransparentIcons ? 0 : 1
            }
            return this.iconThemeIdx
          },
          isSaveUserCfgs: {
            set(val) {
              this.ui.isSaveUserCfgs = val
            },
            get() {
              return this.ui.isSaveUserCfgs
            }
          },
          // 我的图标
          myIcon() {
            return this.box.usercfgs.icon
          },
          // 是否隐藏`我的`标题
          isHideMyTitle() {
            return this.box.usercfgs.isHideMyTitle
          },
          // 添加`应用订阅`对话框
          addAppSubDialog: {
            get() {
              return this.ui.addAppSubDialog.show
            },
            set(show) {
              this.ui.addAppSubDialog.show = show
            }
          },
          // 获取持久化数据
          datas() {
            return this.box.datas
          },
          // 应用会话数据
          sessions() {
            return this.box.sessions
          },
          // 获取`收藏`应用
          favApps() {
            const favapps = []
            const favAppIds = this.box.usercfgs.favapps || []
            if (favAppIds) {
              favAppIds.forEach((favAppId) => {
                const app = this.apps.find((app) => app.id === favAppId)
                if (app) {
                  favapps.push(app)
                }
              })
            }
            return favapps
          },
          // 获取`内置`应用
          sysApps() {
            const sysapps = this.box.sysapps || []
            sysapps.forEach((app) => this.loadAppBaseInfo(app))
            sysapps.sort((a, b) => a.name.localeCompare(b.name))
            return sysapps
          },
          // 获取`订阅`应用 (注意: 这个接口是获取`应用`)
          subApps() {
            const apps = []
            this.appSubs.forEach((appsub) => {
              const sub = this.appSubCaches[appsub.url]
              if (sub && sub.apps) {
                sub.apps.forEach((app) => {
                  this.loadAppBaseInfo(app)
                  apps.push(app)
                })
              }
            })
            return apps
          },
          // 获取`应用`订阅 (注意: 这个接口是获取`订阅`)
          appSubs() {
            // 深拷贝一份数据, 避免污染`usercfgs`
            const subs = JSON.parse(JSON.stringify(this.box.usercfgs.appsubs))
            subs.forEach((sub) => {
              const cacheSub = this.appSubCaches[sub.url]
              if (cacheSub) {
                Object.assign(sub, cacheSub)
              } else {
                sub.isErr = true
                sub.apps = []
              }
              sub.name = sub.name ? sub.name : '匿名订阅'
              sub.author = sub.author ? sub.author : '@anonymous'
              sub.repo = sub.repo ? sub.repo : sub.url
            })
            return subs
          },
          // 获取`订阅`缓存
          appSubCaches() {
            return this.box.appSubCaches
          },
          // 获取所有应用`内置应用`+`订阅应用`
          apps() {
            const apps = []
            apps.push(...this.subApps)
            apps.push(...this.sysApps)
            // apps.sort((a, b) => a.name.localeCompare(b.name))
            return apps
          },
          // 获取全局备份
          baks() {
            return this.box.globalbaks
          },
          // 当前应用
          curapp() {
            if (this.view === 'app' && !!this.subview) {
              const appId = decodeURIComponent(decodeURIComponent(this.subview))
              const app = this.apps.find((app) => app.id === appId)
              this.loadAppDataInfo(app)
              return app
            }
          },
          // 当前备份
          curbak() {
            if (this.view === 'bak' && !!this.subview) {
              const bakId = decodeURIComponent(decodeURIComponent(this.subview))
              const bak = this.baks.find((bak) => bak.id === bakId)
              return bak
            }
          }
        },
        watch: {
          'ui.path': {
            handler(newval, oldval) {
              if (!this.isWebApp && !this.isCors) {
                history.pushState({ title: 'BoxJs' }, '', newval)
              }
              const [, view, subview] = newval.split('/')
              this.ui.view = view
              this.ui.subview = subview
              if (oldval) {
                const [, bfview, bfsubview] = oldval.split('/')
                this.ui.bfpath = oldval
                this.ui.bfview = bfview
                this.ui.bfsubview = bfsubview
              }
              // 还原视图当时的滚动值
              const scrollY = this.ui.scrollY[this.path] || 0
              const offsetTop = -this.$vuetify.application.top
              this.$vuetify.goTo(scrollY, { duration: 0, offset: offsetTop })
            }
          },
          'box.usercfgs': {
            deep: true,
            handler(newval, oldval) {
              if (oldval && this.isSaveUserCfgs) {
                this.saveUserCfgs()
              }
              this.isSaveUserCfgs = true
            }
          },
          'box.usercfgs.color_dark_primary': {
            handler() {
              this.loadTheme()
            }
          },
          'box.usercfgs.color_light_primary': {
            handler() {
              this.loadTheme()
            }
          }
        },
        async created() {
          // 如果 url 参数中指定的 baseURL, 则后续的请求都请求到指定的域
          if (window.location.search) {
            const [, baseURL] = /baseURL=(.*?)(&|$)/.exec(window.location.search)
            axios.defaults.baseURL = baseURL || ''
            this.ui.isCors = true
          }
          // 根据路径跳转视图
          if (!this.isCors) {
            const path = location.pathname
            this.path = path === '/' ? '/app' : path
          } else {
            this.path = '/app'
          }
          // 监听浏览器后退事件
          window.addEventListener('popstate', () => (this.path = path), false)
          // 获取 BoxJs 数据, 取到数据再渲染页面
          await axios.get('/query/boxdata').then((resp) => (this.box = resp.data))
          // 获取全局备份
          if (this.view === 'bak') {
            await this.loadGlobalBak()
          }
          // 获取贡献者列表
          this.getContributors()
          this.getVersions()
          this.loadTheme()
        },
        methods: {
          // 记录每个页面的滚动值
          onScroll(event) {
            this.ui.scrollY[this.path] = event.currentTarget.scrollY
          },
          // 页面返回
          back() {
            if (this.view === 'bak' && !this.bfpath) {
              this.path = '/my'
            } else if (this.view === 'app' && !this.bfpath) {
              this.path = '/app'
            } else {
              this.path = this.bfpath
            }
          },
          // 切换当前容器环境
          switchEnv(env) {
            this.env = env
          },
          // 切换当前视图
          switchView(path) {
            if (this.path !== path) {
              this.path = path
            } else {
              const scrollY = this.ui.scrollY[this.path]
              const isTopY = _.isNil(scrollY) || scrollY === 0
              if (path === '/app' && isTopY) {
                Object.assign(this.box.usercfgs, { favapppanel: [], subapppanel: [], sysapppanel: [] })
              } else if (path === '/sub' && isTopY) {
                this.reloadAppSub()
              }
              if (this.ui.scrollY[path] !== 0) {
                this.$vuetify.goTo(0, { duration: 200, offset: 0 })
              }
            }
          },
          // 切换应用视图
          switchAppView(appId) {
            this.path = `/app/${appId}`
          },
          // 切换备份视图
          switchBakView(bakId) {
            const bak = this.baks.find((bak) => bak.id === bakId)
            if (!bak.bak) {
              this.loadGlobalBak().then((resp) => (this.path = `/bak/${bakId}`))
            } else {
              this.path = `/bak/${bakId}`
            }
          },
          // 重载主题
          loadTheme() {
            this.$vuetify.theme.dark = this.isDarkMode
            this.$vuetify.theme.themes.light.primary = this.box.usercfgs.color_light_primary || '#F7BB0E'
            this.$vuetify.theme.themes.dark.primary = this.box.usercfgs.color_dark_primary || '#2196F3'
          },
          // 复制文件
          copy(str) {
            this.$copyText(str).then(
              (e) => {
                this.ui.snackbar.show = true
                this.ui.snackbar.msg = '复制成功!'
                this.ui.snackbar.color = 'primary'
              },
              (e) => {
                this.ui.snackbar.show = true
                this.ui.snackbar.msg = '复制失败!'
                this.ui.snackbar.color = 'error'
              }
            )
          },
          // 移动收藏
          moveFav(favIdx, moveCnt) {
            const favapps = this.box.usercfgs.favapps
            const fromIdx = favIdx
            const toIdx = favIdx + moveCnt
            favapps.splice(fromIdx, 1, ...favapps.splice(toIdx, 1, favapps[fromIdx]))
          },
          // 移动订阅
          moveSub(subIdx, moveCnt) {
            const appsubs = this.box.usercfgs.appsubs
            const fromIdx = subIdx
            const toIdx = subIdx + moveCnt
            appsubs.splice(fromIdx, 1, ...appsubs.splice(toIdx, 1, appsubs[fromIdx]))
          },
          // 删除订阅
          delSub(subIdx) {
            this.box.usercfgs.appsubs.splice(subIdx, 1)
          },
          // 收藏应用
          favApp(appId) {
            const favAppIdx = this.box.usercfgs.favapps.findIndex((favAppId) => favAppId === appId)
            if (favAppIdx === -1) {
              this.box.usercfgs.favapps.push(appId)
            } else {
              this.box.usercfgs.favapps.splice(favAppIdx, 1)
            }
          },
          // 加载应用信息
          loadAppBaseInfo(app) {
            // 应用图标
            app.icons = app.icons ? app.icons : this.ui.defaultIcons
            app.icon = app.icons[this.iconThemeIdx]
            // 是否收藏
            const isFav = this.box.usercfgs.favapps.includes(app.id)
            app.favIcon = isFav ? 'mdi-star' : 'mdi-star-outline'
            app.favIconColor = isFav ? 'primary' : 'grey'
          },
          // 加载应用数据
          loadAppDataInfo(app) {
            if (app.isLoaded) return
            // 加载应用设置
            if (app.settings) {
              app.settings.forEach((setting) => {
                const key = setting.id
                const datval = this.datas[key]
                if (setting.type === 'boolean') {
                  setting.val = datval === null ? setting.val : datval === 'true'
                } else if (setting.type === 'int') {
                  setting.val = datval * 1 || setting.val
                } else if (setting.type === 'checkboxes') {
                  if (!_.isNil(datval)) {
                    setting.val = datval ? datval.split(',') : []
                  }
                } else {
                  setting.val = datval || setting.val
                }
              })
            }
            // 加载当前会话数据
            if (app.keys) {
              app.datas = []
              app.keys.forEach((key) => {
                const val = this.datas[key] || ''
                app.datas.push({ key, val })
              })
            }
            // 加载会话列表
            const sessions = this.sessions.filter((session) => session.appId === app.id)
            app.sessions = sessions || []

            // 加载当前切换会话
            const curSessionId = this.box.curSessions[app.id]
            if (curSessionId) {
              const curSession = this.sessions.find((session) => session.id === curSessionId)
              app.curSession = curSession
            }
            app.isLoaded = true
          },
          // 运行脚本
          runScript(url, timeout) {
            this.ui.overlay.show = true
            const opts = { url, timeout }
            axios
              .post('/api/runScript', opts)
              .then((resp) => {})
              .finally(() => (this.ui.overlay.show = false))
          },
          // 保存用户偏好
          saveUserCfgs() {
            const key = 'chavy_boxjs_userCfgs'
            const val = JSON.stringify(this.box.usercfgs)
            axios.post('/api/save', [{ key, val }]).then((resp) => {
              this.loadTheme()
            })
          },
          // 保存应用设置
          saveAppSettings() {
            this.ui.overlay.show = true
            const datas = []
            this.curapp.settings.forEach((setting) => {
              const isNilVal = _.isNil(setting.val)
              const key = setting.id
              const val = !isNilVal ? _.toString(setting.val) : ''
              datas.push({ key, val })
            })
            axios
              .post('/api/save', datas)
              .then((resp) => {
                if (this.curapp.id === 'BoxSetting') {
                  this.isSaveUserCfgs = false
                } else {
                  delete resp.data.usercfgs
                }
                Object.assign(this.box, resp.data)
              })
              .finally(() => (this.ui.overlay.show = false))
          },
          // 保存应用会话
          saveAppSession() {
            this.ui.overlay.show = true
            const session = {
              id: uuidv4(),
              name: '会话 ' + (this.curapp.sessions.length + 1),
              appId: this.curapp.id,
              appName: this.curapp.name,
              enable: true,
              createTime: new Date(),
              datas: this.curapp.datas
            }
            this.box.sessions.push(session)
            const key = 'chavy_boxjs_sessions'
            const val = JSON.stringify(this.box.sessions)
            axios
              .post('/api/save', [{ key, val }])
              .then((resp) => {
                delete resp.data.usercfgs
                Object.assign(this.box, resp.data)
              })
              .finally(() => (this.ui.overlay.show = false))
          },
          // 删除应用会话
          delAppSession(sessionId) {
            this.ui.overlay.show = true
            const sessions = this.box.sessions
            const sessionIdx = sessions.findIndex((session) => session.id === sessionId)
            sessions.splice(sessionIdx, 1)
            const key = 'chavy_boxjs_sessions'
            const val = JSON.stringify(this.box.sessions)
            axios
              .post('/api/save', [{ key, val }])
              .then((resp) => {
                delete resp.data.usercfgs
                Object.assign(this.box, resp.data)
              })
              .finally(() => (this.ui.overlay.show = false))
          },
          // 使用应用会话
          useAppSession(sessionId) {
            this.ui.overlay.show = true
            const sessions = this.box.sessions
            const session = sessions.find((session) => session.id === sessionId)
            this.box.curSessions[session.appId] = sessionId

            const key = 'chavy_boxjs_cur_sessions'
            const val = JSON.stringify(this.box.curSessions)
            const curSessions = [{ key, val }]
            const datas = [...session.datas, ...curSessions]
            axios
              .post('/api/save', datas)
              .then((resp) => {
                delete resp.data.usercfgs
                Object.assign(this.box, resp.data)
              })
              .finally(() => (this.ui.overlay.show = false))
          },
          // 保存应用数据
          clearAppDatas(key) {
            this.ui.overlay.show = true
            const datas = this.curapp.datas
            const data = datas.find((data) => data.key === key)
            data.val = ''
            axios
              .post('/api/save', datas)
              .then((resp) => {
                if (this.curapp.id === 'BoxSetting') {
                  this.isSaveUserCfgs = false
                } else {
                  delete resp.data.usercfgs
                }
                Object.assign(this.box, resp.data)
              })
              .finally(() => (this.ui.overlay.show = false))
          },
          // 导入应用数据
          impAppDatas() {
            this.ui.overlay.show = true
            this.ui.impAppDatasDialog = false
            const impval = this.ui.impAppDatasDialog.impval
            const impapp = JSON.parse(impval)
            const datas = impapp.datas || []
            impapp.settings.forEach((setting) => {
              const { id: key, val } = setting
              datas.push({ key, val })
            })
            axios
              .post('/api/save', datas)
              .then((resp) => {
                delete resp.data.usercfgs
                Object.assign(this.box, resp.data)
              })
              .finally(() => (this.ui.overlay.show = false))
          },
          // 添加应用订阅
          addAppSub(url) {
            this.ui.overlay.show = true
            this.addAppSubDialog = false
            const sub = {
              id: uuidv4(),
              url,
              enable: true
            }
            axios
              .post('/api/addAppSub', sub)
              .then((resp) => {
                this.isSaveUserCfgs = false
                Object.assign(this.box, resp.data)
              })
              .finally(() => (this.ui.overlay.show = false))
          },
          // 重载应用订阅
          reloadAppSub(sub) {
            this.ui.overlay.show = true
            axios
              .post('/api/reloadAppSub', sub)
              .then((resp) => {
                delete resp.data.usercfgs
                Object.assign(this.box, resp.data)
              })
              .finally(() => (this.ui.overlay.show = false))
          },
          // 加载完整的全局备份 (页面渲染时加载只是备份列表)
          loadGlobalBak() {
            this.ui.overlay.show = true
            return axios
              .get('/query/baks')
              .then((resp) => {
                delete resp.data.usercfgs
                Object.assign(this.box, resp.data)
              })
              .finally(() => (this.ui.overlay.show = false))
          },
          // 删除全局备份
          delGlobalBak() {
            this.ui.overlay.show = true
            const { id } = this.curbak
            axios
              .post('/api/delGlobalBak', { id })
              .then((resp) => {
                this.back()
                delete resp.data.usercfgs
                Object.assign(this.box, resp.data)
              })
              .finally(() => (this.ui.overlay.show = false))
          },
          // 保存当前备份
          updateGlobalBak() {
            this.ui.overlay.show = true
            const { id, name } = this.curbak
            axios
              .post('/api/updateGlobalBak', { id, name })
              .then((resp) => {
                delete resp.data.usercfgs
                Object.assign(this.box, resp.data)
              })
              .finally(() => (this.ui.overlay.show = false))
          },
          // 导入全局备份
          impGlobalBak() {
            this.ui.impGlobalBakDialog.show = false
            this.ui.overlay.show = true
            const impval = this.ui.impGlobalBakDialog.impval
            const bak = {
              id: uuidv4(),
              name: '全局备份 ' + (this.box.globalbaks.length + 1),
              env: this.box.syscfgs.env,
              version: this.box.syscfgs.version,
              versionType: this.box.syscfgs.versionType,
              createTime: new Date(),
              bak: JSON.parse(impval)
            }
            bak.tags = [bak.env, bak.version, bak.versionType]
            axios
              .post('/api/impGlobalBak', bak)
              .then((resp) => {
                delete resp.data.usercfgs
                Object.assign(this.box, resp.data)
              })
              .finally(() => {
                this.ui.overlay.show = false
                this.ui.impGlobalBakDialog.impval = ''
              })
          },
          // 保存备份
          saveGlobalBak() {
            this.ui.overlay.show = true
            const bak = {
              id: uuidv4(),
              name: '全局备份 ' + (this.box.globalbaks.length + 1),
              env: this.box.syscfgs.env,
              version: this.box.syscfgs.version,
              versionType: this.box.syscfgs.versionType,
              createTime: new Date()
            }
            bak.tags = [bak.env, bak.version, bak.versionType]
            axios
              .post('/api/saveGlobalBak', bak)
              .then((resp) => {
                delete resp.data.usercfgs
                Object.assign(this.box, resp.data)
              })
              .finally(() => (this.ui.overlay.show = false))
          },
          // 还原备份
          revertGlobalBak() {
            this.ui.overlay.show = true
            const { id } = this.curbak
            axios
              .post('/api/revertGlobalBak', { id })
              .then((resp) => {
                this.isSaveUserCfgs = false
                Object.assign(this.box, resp.data)
              })
              .finally(() => {
                this.loadTheme()
                this.ui.overlay.show = false
              })
          },
          // 获取仓库贡献者
          getContributors() {
            const url = 'https://api.github.com/repos/chavyleung/scripts/contributors'
            axios.get(url).then((resp) => {
              this.box.syscfgs.contributors = []
              resp.data.forEach((contributor) => {
                if ([29748519, 39037656].includes(contributor.id)) return
                const { login: id, login, html_url: repo, avatar_url: icon } = contributor
                this.ui.contributors.push({ id, login, repo, icon })
              })
            })
          },
          // 获取版本清单
          getVersions() {
            axios.get('/query/versions').then((resp) => {
              if (resp.data && resp.data.releases) {
                Object.assign(this.box, { versions: resp.data.releases })
                if (this.hasNewVersion) {
                  this.ui.versionsheet.show = true
                }
              }
            })
          },
          // 对比版本号
          compareVersion(v1, v2) {
            var _v1 = v1.split('.'),
              _v2 = v2.split('.'),
              _r = _v1[0] - _v2[0]
            return _r == 0 && v1 != v2 ? this.compareVersion(_v1.splice(1).join('.'), _v2.splice(1).join('.')) : _r
          }
        }
      })
    </script>
  </body>
</html>
